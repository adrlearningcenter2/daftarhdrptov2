<script>

const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzHDBoFZMjfG4DbfdKGJpXY0DKSmZUKtGJV_bbVMMmzB-Le-3HaFL79MgCM-sFvf0Kb/exec";

/* =========================
   LOAD MATERI
========================= */

function loadMateri() {
  fetch(WEB_APP_URL + "?action=getMateri")
    .then(res => res.json())
    .then(data => {
      const select = document.getElementById("namaMateri");
      select.innerHTML = '<option value="">Pilih Materi</option>';
      data.forEach(materi => {
        select.innerHTML += `<option>${materi}</option>`;
      });
    });
}
loadMateri();

/* =========================
   AUTO READ MASTER KARYAWAN
========================= */

document.getElementById("nip").addEventListener("blur", function () {

  const nipValue = this.value.trim();
  if (!nipValue) return;

  fetch(WEB_APP_URL + "?action=getKaryawan&nip=" + encodeURIComponent(nipValue))
    .then(res => res.json())
    .then(data => {

      if (data.status === "success") {
        document.getElementById("nama").value = data.nama || "";
        document.getElementById("subDivisi").value = data.subDivisi || "";
        document.getElementById("departemen").value = data.departemen || "";
      } else {
        document.getElementById("nama").value = "";
        document.getElementById("subDivisi").value = "";
        document.getElementById("departemen").value = "";
      }

    })
    .catch(err => console.log("Lookup error:", err));
});

/* =========================
   SIGNATURE
========================= */

const canvas = document.getElementById("signaturePad");
const ctx = canvas.getContext("2d");
let drawing = false;

canvas.addEventListener("mousedown", startDraw);
canvas.addEventListener("mouseup", stopDraw);
canvas.addEventListener("mousemove", draw);

canvas.addEventListener("touchstart", startDraw);
canvas.addEventListener("touchend", stopDraw);
canvas.addEventListener("touchmove", draw);

function startDraw(e) {
  drawing = true;
  ctx.beginPath();
}

function stopDraw() {
  drawing = false;
}

function draw(e) {
  if (!drawing) return;
  e.preventDefault();

  const rect = canvas.getBoundingClientRect();
  const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
  const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

  ctx.lineWidth = 2;
  ctx.lineCap = "round";
  ctx.lineTo(x, y);
  ctx.stroke();
}

function clearSignature() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

/* =========================
   SUBMIT
========================= */

document.getElementById("attendanceForm").addEventListener("submit", function(e){

  e.preventDefault();
  document.getElementById("loading").classList.remove("hidden");

  const formData = new URLSearchParams();

  formData.append("nip", document.getElementById("nip").value);
  formData.append("nama", document.getElementById("nama").value);
  formData.append("subDivisi", document.getElementById("subDivisi").value);
  formData.append("departemen", document.getElementById("departemen").value);
  formData.append("jenisPelatihan", document.getElementById("jenisPelatihan").value);
  formData.append("batchPTO", document.getElementById("batchPTO").value);
  formData.append("kehadiran", document.getElementById("kehadiran").value);
  formData.append("namaMateri", document.getElementById("namaMateri").value);
  formData.append("tanggal", document.getElementById("tanggal").value);
  formData.append("signature", canvas.toDataURL());

  fetch(WEB_APP_URL, { method: "POST", body: formData })
    .then(res => res.json())
    .then(response => {

      document.getElementById("loading").classList.add("hidden");

      if (response.status === "success") {

        const toast = document.getElementById("toast");
        toast.classList.remove("hidden");

        setTimeout(() => {
          toast.classList.add("hidden");
        }, 3000);

        document.getElementById("attendanceForm").reset();
        clearSignature();

      } else {
        alert("Gagal menyimpan: " + response.message);
      }

    })
    .catch(err => {
      document.getElementById("loading").classList.add("hidden");
      alert("Terjadi kesalahan koneksi.");
      console.log(err);
    });

});

</script>