<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daftar Hadir Training PTO</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">

<header class="bg-indigo-600 text-white py-4 shadow-lg">
  <div class="max-w-4xl mx-auto px-4 flex justify-between items-center">
    <h1 class="text-xl md:text-2xl font-bold">Sistem Daftar Hadir Training</h1>
    <a href="admin.html" class="text-sm underline">Admin</a>
  </div>
</header>

<div class="max-w-4xl mx-auto p-4 md:p-6">
  <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 mt-6">

    <h2 class="text-lg font-semibold mb-6 text-gray-700">Form Absensi Peserta</h2>

    <form id="attendanceForm" class="space-y-4">

      <input type="text" id="idPeserta" placeholder="ID Peserta"
        class="w-full border rounded-xl p-3" required>

      <input type="text" id="namaLengkap" placeholder="Nama Lengkap"
        class="w-full border rounded-xl p-3" required>

      <input type="text" id="subDivisi" placeholder="Sub Divisi"
        class="w-full border rounded-xl p-3">

      <input type="text" id="departemen" placeholder="Departemen"
        class="w-full border rounded-xl p-3">

      <select id="jenisPelatihan"
        class="w-full border rounded-xl p-3" required>
        <option value="">Pilih Program</option>
        <option value="BASIC">BASIC</option>
        <option value="MULTISKILL">MULTISKILL</option>
      </select>

      <input type="text" id="batchPTO" placeholder="Batch PTO"
        class="w-full border rounded-xl p-3" required>

      <select id="kehadiran"
        class="w-full border rounded-xl p-3" required>
        <option value="">Pilih Kehadiran</option>
        <option>Hadir</option>
        <option>Sakit</option>
        <option>Tidak Hadir</option>
      </select>

      <select id="namaMateri"
        class="w-full border rounded-xl p-3" required>
        <option value="">Memuat materi...</option>
      </select>

      <input type="date" id="tanggal"
        class="w-full border rounded-xl p-3" required>

      <div>
        <label class="block mb-2 font-medium text-gray-600">Tanda Tangan</label>
        <canvas id="signaturePad"
          width="600" height="200"
          class="w-full border rounded-xl bg-gray-50 touch-none"></canvas>
        <button type="button" onclick="clearSignature()"
          class="mt-2 text-sm text-red-600 hover:underline">
          Hapus Tanda Tangan
        </button>
      </div>

      <button type="submit"
        class="w-full bg-indigo-600 text-white py-3 rounded-xl">
        Submit
      </button>

    </form>
  </div>
</div>

<div id="toast"
  class="fixed top-5 right-5 bg-green-600 text-white px-6 py-3 rounded-xl hidden">
  Berhasil disimpan!
</div>

<div id="loading"
  class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden">
  <div class="bg-white p-6 rounded-xl flex items-center gap-3">
    <div class="animate-spin rounded-full h-6 w-6 border-4 border-indigo-600 border-t-transparent"></div>
    <span>Menyimpan...</span>
  </div>
</div>

<script>

const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxic1hh5ytuGhAUZGB3cnbvTdaJyXHHF71kEVK5lyRw5oHUoaKbZQkG-4ms9XQNyCI/exec";

/* LOAD MATERI */
function loadMateri() {
  fetch(WEB_APP_URL + "?action=getMateri")
    .then(res => res.json())
    .then(data => {
      const select = document.getElementById("namaMateri");
      select.innerHTML = '<option value="">Pilih Materi</option>';
      data.forEach(materi => {
        select.innerHTML += `<option>${materi}</option>`;
      });
    });
}
loadMateri();

/* SIGNATURE */
const canvas = document.getElementById("signaturePad");
const ctx = canvas.getContext("2d");
let drawing = false;

function getPosition(event) {
  const rect = canvas.getBoundingClientRect();
  if (event.touches) {
    return {
      x: event.touches[0].clientX - rect.left,
      y: event.touches[0].clientY - rect.top
    };
  } else {
    return {
      x: event.clientX - rect.left,
      y: event.clientY - rect.top
    };
  }
}

function startDrawing(event) {
  drawing = true;
  ctx.beginPath();
  const pos = getPosition(event);
  ctx.moveTo(pos.x, pos.y);
}

function draw(event) {
  if (!drawing) return;
  event.preventDefault();
  const pos = getPosition(event);
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#000";
  ctx.lineTo(pos.x, pos.y);
  ctx.stroke();
}

function stopDrawing() {
  drawing = false;
}

canvas.addEventListener("mousedown", startDrawing);
canvas.addEventListener("mousemove", draw);
canvas.addEventListener("mouseup", stopDrawing);
canvas.addEventListener("touchstart", startDrawing);
canvas.addEventListener("touchmove", draw);
canvas.addEventListener("touchend", stopDrawing);

function clearSignature() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

/* SUBMIT */
document.getElementById("attendanceForm").addEventListener("submit", function(e){
  e.preventDefault();
  document.getElementById("loading").classList.remove("hidden");

  const formData = new URLSearchParams();
  formData.append("idPeserta", idPeserta.value);
  formData.append("namaLengkap", namaLengkap.value);
  formData.append("subDivisi", subDivisi.value);
  formData.append("departemen", departemen.value);
  formData.append("jenisPelatihan", jenisPelatihan.value);
  formData.append("batchPTO", batchPTO.value);
  formData.append("kehadiran", kehadiran.value);
  formData.append("namaMateri", namaMateri.value);
  formData.append("tanggal", tanggal.value);
  formData.append("signature", canvas.toDataURL());

  fetch(WEB_APP_URL, { method: "POST", body: formData })
    .then(res => res.json())
    .then(() => {
      document.getElementById("loading").classList.add("hidden");
      toast.classList.remove("hidden");
      setTimeout(() => toast.classList.add("hidden"), 3000);
      attendanceForm.reset();
      clearSignature();
    });
});

</script>
</body>
</html>